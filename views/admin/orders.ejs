<%- include("../partials/admin/header", { 
  title: "Orders",
  adminName: typeof adminName !== "undefined" ? adminName : "Admin",
  activeMenu: "orders"
}) %>

<style>
.dashboard-content {
  background-color: #f5f5f5;
  min-height: 100vh;
  padding: 20px;
}

.content-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.content-header h1 {
  font-size: 28px;
  font-weight: 600;
  color: #333;
}

.table-order {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,.05);
}

.table-order table {
  width: 100%;
  border-collapse: collapse;
}

.table-order thead {
  background: #f9f9f9;
}

.table-order th,
.table-order td {
  padding: 16px;
  font-size: 14px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pending { background:#fff3cd; color:#856404; }
.status-delivered { background:#d4edda; color:#155724; }
.status-cancelled { background:#f8d7da; color:#721c24; }

button {
  padding: 8px 14px;
  background: #007bff;
  border: none;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 6px;
}

button.reject {
  background: #dc3545;
}

button:hover {
  opacity: .9;
}

select {
  padding: 6px 10px;
  border-radius: 4px;
}
</style>

<div class="dashboard-content">

  <div class="content-header">
    <h1>Orders</h1>
  </div>

  <div class="table-order">
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Product</th>
          <th>Status</th>
          <th>Return Reason</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        <% if(!orders || orders.length === 0){ %>
          <tr>
            <td colspan="6">No orders found</td>
          </tr>
        <% } %>

        <% orders.forEach(order => { %>
          <% order.items.forEach(item => { %>

            <tr>
              <td><%= order.orderId %></td>
              <td><%= order.userId?.fullname || "User" %></td>
              <td><%= item.productId?.product_name || "Product" %></td>

              <!-- STATUS -->
              <td>
                <span class="status-badge
                  <%= item.status === 'return_requested' ? 'status-pending'
                    : item.status === 'returned' ? 'status-delivered'
                    : item.status === 'return_rejected' ? 'status-cancelled'
                    : 'status-' + item.status %>">
                  <%= item.status.replace("_"," ").toUpperCase() %>
                </span>
              </td>

              <!-- RETURN REASON -->
              <td>
                <% if(item.status === "return_requested"){ %>
                  <strong><%= item.returnReason %></strong>
                <% } else { %>
                  —
                <% } %>
              </td>

              <!-- ACTIONS -->
              <td>
                <!-- PENDING ITEM -->
                <% if(item.status === "pending"){ %>

                  <select onchange="updateItemStatus(
                    '<%= order._id %>',
                    '<%= item.productId._id %>',
                    this.value
                  )">
                    <option selected disabled>Change</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                  </select>

                <!-- RETURN REQUEST -->
                <% } else if(item.status === "return_requested"){ %>

                  <button
                    onclick="handleReturn(
                      '<%= order._id %>',
                      '<%= item.productId._id %>',
                      'approve'
                    )">
                    Accept
                  </button>

                  <button class="reject"
                    onclick="handleReturn(
                      '<%= order._id %>',
                      '<%= item.productId._id %>',
                      'reject'
                    )">
                    Reject
                  </button>

                <% } else { %>
                  —
                <% } %>
              </td>
            </tr>

          <% }) %>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
async function updateItemStatus(orderId, productId, status) {
  if (!confirm("Change item status?")) return;

  const res = await fetch("/admin/orders/update-item-status", {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ orderId, productId, status })
  });

  const data = await res.json();
  if (data.success) location.reload();
  else alert(data.message || "Update failed");
}

async function handleReturn(orderId, productId, action) {
  if (!confirm(`Are you sure you want to ${action} this return?`)) return;

  const res = await fetch("/admin/orders/process-return", {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ orderId, productId, action })
  });

  const data = await res.json();

  if (data.success) {
    location.reload();
  } else {
    alert(data.message || "Action failed");
  }
}

</script>

<%- include("../partials/admin/footer") %>
