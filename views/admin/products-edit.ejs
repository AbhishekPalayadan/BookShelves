<%- include("../partials/admin/header", { title: "Edit Product", adminName: "Admin", activeMenu: "products" }) %>

<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" onload="this.media='all'" media="print"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>

.edit-wrapper { padding:20px 17px; }
.product-card { background:#fff; padding:22px; border-radius:10px; border:1px solid #e6e6e6; display:flex; gap:30px; flex-wrap:wrap; }
.left-column { width:280px; min-width:220px; }
.main-preview { width:100%; height:280px; border-radius:12px; background:#f7f7f7; border:2px dashed #ddd; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
.main-preview img { max-width:100%; max-height:100%; object-fit:contain; cursor:pointer; display:block; }
.placeholder { text-align:center; color:#888; }
.select-btn { margin-top:12px; width:100%; padding:11px; border:2px solid #888; border-radius:8px; background:#fff; font-weight:600; cursor:pointer; }
.thumbs { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; }
.thumb { width:60px; height:60px; border-radius:8px; border:1px solid #ddd; overflow:hidden; position:relative; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.thumb .rm { position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.7); color:#fff; border:none; width:22px; height:22px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:5; cursor:pointer; }
.main-crop-btn { position:absolute; bottom:12px; right:12px; background:#4caf50; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; z-index:30; font-weight:600; }
.cropper-container img { max-width:none !important; }
.right-column { flex:1; display:grid; grid-template-columns:repeat(2,1fr); gap:18px; min-width:320px; }
.form-field { display:flex; flex-direction:column; }
.form-field input, .form-field textarea, .form-field select { padding:10px; border:1px solid #ccc; border-radius:8px; }
.submit-btn { grid-column: 1 / -1; padding:12px; background:#ff3b3b; color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top:8px; }
</style>

<div class="edit-wrapper">
  <div class="content-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
    <h1 style="font-size:28px; font-weight:600; color:#333;">Edit Product</h1>
  </div>

  <div class="product-card">

    <div class="left-column">
      <div class="main-preview" id="mainPreviewBox">
        <img id="imgViewMain" src="" alt="Main preview" style="display:none;">
        <div id="placeholderBlock" class="placeholder">
          <i class="fa-solid fa-image" style="font-size:56px; display:block; margin-bottom:8px;"></i>
          <div style="font-weight:600">Product Image</div>
          <div style="font-size:13px; color:#999;">(No image selected)</div>
        </div>
        <button id="mainCropBtn" class="main-crop-btn" type="button" style="display:none;">Crop</button>
      </div>

      <input type="file" id="input1" accept="image/*" multiple style="display:none;">
      <button type="button" class="select-btn" onclick="document.getElementById('input1').click()">Select Images (max 4)</button>

      <div id="addedImagesContainer" class="thumbs" aria-live="polite"></div>
    </div>

    <div class="right-column">
      <div class="form-field">
        <label>Product Name</label>
        <input id="f_productName" type="text" name="productName" value="<%= product.product_name %>" />
      </div>

      <div class="form-field">
        <label>Author</label>
        <input id="f_author" type="text" name="author" value="<%= product.author %>" />
      </div>

      <div class="form-field" style="grid-column:1 / -1;">
        <label>Description</label>
        <textarea id="f_description" name="description" rows="4"><%= product.description || '' %></textarea>
      </div>

      <div class="form-field">
        <label>Publisher (optional)</label>
        <input id="f_publisher" type="text" name="publisher" value="" />
      </div>

      <div class="form-field">
        <label>Published Date</label>
        <input id="f_publishedDate" type="date" name="publishedDate" value="<%= product.published_date ? product.published_date.toISOString().split('T')[0] : '' %>" />
      </div>

      <div class="form-field">
        <label>Category</label>
        <select id="f_category" name="category">
          <% cat.forEach(c => { %>
            <option value="<%= c._id %>" <%= String(c._id) === String(product.category_id) ? 'selected' : '' %>><%= c.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-field">
        <label>Stock Quantity</label>
        <input id="f_stockQuantity" type="number" name="stockQuantity" value="<%= product.stock %>" />
      </div>

      <div class="form-field">
        <label>Page Count</label>
        <input id="f_pageCount" type="number" name="pageCount" value="" />
      </div>

      <div class="form-field">
        <label>Language</label>
        <input id="f_language" type="text" name="language" value="<%= product.language || '' %>" />
      </div>

      <div class="form-field">
        <label>Regular Price</label>
        <input id="f_regularPrice" type="number" name="regularPrice" value="<%= product.regular_price || '' %>" />
      </div>

      <div class="form-field">
        <label>Sale Price</label>
        <input id="f_salePrice" type="number" name="salePrice" value="<%= product.sale_price || '' %>" />
      </div>

      <button id="saveBtn" class="submit-btn">Save Changes</button>
    </div>


    <form id="hiddenForm" style="display:none"></form>

  </div>
</div>


<div id="cropModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:center; z-index:9999;">
  <div style="width:90%; max-width:920px; background:#fff; padding:14px; border-radius:10px;">
    <h3 style="margin:6px 0 12px;">Crop Image</h3>
    <div style="max-height:72vh; overflow:auto;">
      <img id="cropImage" src="" style="max-width:100%; display:block; margin:0 auto;">
    </div>
    <div style="text-align:right; margin-top:12px;">
      <button id="cancelCrop" type="button" style="padding:8px 12px; border-radius:6px; background:#ccc; border:none; margin-right:8px;">Cancel</button>
      <button id="applyCrop" type="button" style="padding:8px 12px; border-radius:6px; background:#4caf50; color:#fff; border:none;">Apply Crop</button>
    </div>
  </div>
</div>

<script>

const existingImages = <%- JSON.stringify(product.images || []) %>;
let keptExisting = existingImages.slice();
const MAX_FILES = 4;

const input1 = document.getElementById('input1');
const addedImagesContainer = document.getElementById('addedImagesContainer');
const imgViewMain = document.getElementById('imgViewMain');
const placeholderBlock = document.getElementById('placeholderBlock');
const mainCropBtn = document.getElementById('mainCropBtn');

const cropModal = document.getElementById('cropModal');
const cropImage = document.getElementById('cropImage');
const cancelCrop = document.getElementById('cancelCrop');
const applyCrop = document.getElementById('applyCrop');

let filesDT = new DataTransfer();        
let originalNewFiles = [];              
let mainIndex = null;                  
let cropper = null;


function buildCombinedList() {
  const combined = [];

  keptExisting.forEach(fn => combined.push({ type: 'existing', name: fn, url: '/uploads/product-images/' + fn }));

  Array.from(filesDT.files).forEach(f => combined.push({ type: 'new', file: f, url: URL.createObjectURL(f) }));
  return combined;
}

function renderThumbnails() {
  const combined = buildCombinedList();
  addedImagesContainer.innerHTML = '';

  if (combined.length === 0) {
    imgViewMain.style.display = 'none';
    placeholderBlock.style.display = 'block';
    mainCropBtn.style.display = 'none';
    mainIndex = null;
    return;
  }

  if (mainIndex === null || mainIndex >= combined.length) mainIndex = 0;

  updateMainPreviewFromCombinedIndex(mainIndex);

  combined.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'thumb';

    const img = document.createElement('img');
    img.src = item.url;
    div.appendChild(img);


    div.addEventListener('click', (ev) => {
      ev.stopPropagation();
      mainIndex = idx;
      updateMainPreviewFromCombinedIndex(idx);
    });


    const rm = document.createElement('button');
    rm.className = 'rm';
    rm.innerHTML = '&times;';
    rm.addEventListener('click', (ev) => {
      ev.stopPropagation();
      removeCombinedIndex(idx);
    });
    div.appendChild(rm);

    addedImagesContainer.appendChild(div);
  });
}


function removeCombinedIndex(idx) {
  const combined = buildCombinedList();
  const item = combined[idx];
  if (!item) return;

  if (item.type === 'existing') {

    keptExisting = keptExisting.filter(fn => fn !== item.name);
  } else {

    const newDT = new DataTransfer();
    Array.from(filesDT.files).forEach((f, i) => {
      if (i !== (idx - existingImages.length + (existingImages.length - keptExisting.length))) {

      }
    });

    const removeUrl = item.url;
    const tmpFiles = Array.from(filesDT.files).filter(f => URL.createObjectURL(f) !== removeUrl);
    const dt2 = new DataTransfer();
    tmpFiles.forEach(f => dt2.items.add(f));
    filesDT = dt2;
  }


  renderThumbnails();
}


function updateMainPreviewFromCombinedIndex(index) {
  const combined = buildCombinedList();
  const item = combined[index];
  if (!item) {
    imgViewMain.style.display = 'none';
    placeholderBlock.style.display = 'block';
    mainCropBtn.style.display = 'none';
    return;
  }
  imgViewMain.src = item.url;
  imgViewMain.style.display = 'block';
  placeholderBlock.style.display = 'none';


  if (item.type === 'new') mainCropBtn.style.display = 'inline-block';
  else mainCropBtn.style.display = 'none';
}


input1.addEventListener('change', (e) => {
  const selected = Array.from(e.target.files || []);
  const currentCount = keptExisting.length + filesDT.files.length;
  const space = MAX_FILES - currentCount;
  if (selected.length > space) {
    alert('You can add ' + space + ' more images.');
    selected.splice(space);
  }

  selected.forEach(file => {
    originalNewFiles.push(file);
    filesDT.items.add(file);
  });

  input1.files = filesDT.files;
  renderThumbnails();
});


imgViewMain.addEventListener('click', () => {
  const combined = buildCombinedList();
  const item = combined[mainIndex];
  if (!item) return;
  if (item.type === 'new'){
    openCropperForNewIndex(mainIndex - keptExisting.length);
  }else{
    openCropperForExistingIndex(mainIndex)
  }
})

function openCropperForExistingIndex(idx) {
    const imgName = keptExisting[idx];
    if (!imgName) return;

    cropImage.src = "/uploads/product-images/" + imgName;
    cropModal.style.display = 'flex';

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    cropper = new Cropper(cropImage, {
        viewMode: 1,
        autoCropArea: 1,
        movable: true,
        zoomable: true,
        aspectRatio: 3 / 4
    });

    cropModal.dataset.existingIndex = idx;
}


mainCropBtn.addEventListener('click', () => {
  const combined = buildCombinedList();
  const item = combined[mainIndex];
  if (!item) return;
  if (item.type === 'new') openCropperForNewIndex(mainIndex - keptExisting.length);
});


function openCropperForNewIndex(newIndex) {
  const f = Array.from(filesDT.files)[newIndex];
  if (!f) return alert('File not found for cropping');
  cropImage.src = URL.createObjectURL(f);
  cropModal.style.display = 'flex';
  if (cropper) { cropper.destroy(); cropper = null; }
  cropper = new Cropper(cropImage, {
    viewMode: 1,
    autoCropArea: 1,
    movable: true,
    zoomable: true,
    aspectRatio: 3/4
  });
  cropModal.dataset.newIndex = newIndex;
}


applyCrop.addEventListener("click", () => {
    if (!cropper) return;

    const existingIndex = cropModal.dataset.existingIndex;
    const newIndex = cropModal.dataset.newIndex;

    cropper.getCroppedCanvas().toBlob((blob) => {

        if (existingIndex !== undefined) {
   
            const name = keptExisting[existingIndex];
            const newFile = new File([blob], "cropped_" + Date.now() + ".png", { type: "image/png" });


            keptExisting.splice(existingIndex, 1);

            filesDT.items.add(newFile);
        }

        if (newIndex !== undefined) {
            const oldFile = filesDT.files[newIndex];
            const newFile = new File([blob], oldFile.name, { type: blob.type });

            const dt = new DataTransfer();
            Array.from(filesDT.files).forEach((f, i) => {
                dt.items.add(i === newIndex ? newFile : f);
            });

            filesDT = dt;
            input1.files = filesDT.files;
        }

        renderThumbnails();
        cropper.destroy(); cropper = null;
        cropModal.style.display = "none";

        delete cropModal.dataset.newIndex;
        delete cropModal.dataset.existingIndex;

    }, "image/png");
});


cancelCrop.addEventListener('click', () => {
  if (cropper) { cropper.destroy(); cropper = null; }
  cropModal.style.display = 'none';
  delete cropModal.dataset.newIndex;
});


document.getElementById('saveBtn').addEventListener('click', (ev) => {
  ev.preventDefault();


  const productName = document.getElementById('f_productName').value.trim();
  if (!productName) { alert('Product name required'); return; }

  const totalCount = keptExisting.length + filesDT.files.length;
  if (totalCount === 0) { alert('Add at least one image'); return; }
  if (totalCount > MAX_FILES) { alert('Max ' + MAX_FILES + ' images allowed'); return; }

  const fd = new FormData();


  fd.append('productName', document.getElementById('f_productName').value);
  fd.append('author', document.getElementById('f_author').value);
  fd.append('description', document.getElementById('f_description').value);
  fd.append('publishedDate', document.getElementById('f_publishedDate').value);
  fd.append('category', document.getElementById('f_category').value);
  fd.append('stockQuantity', document.getElementById('f_stockQuantity').value);
  fd.append('pageCount', document.getElementById('f_pageCount').value);
  fd.append('language', document.getElementById('f_language').value);
  fd.append('regularPrice', document.getElementById('f_regularPrice').value);
  fd.append('salePrice', document.getElementById('f_salePrice').value);


  keptExisting.forEach(fn => fd.append('keepImages', fn));


  Array.from(filesDT.files).forEach(file => {
    fd.append('images', file, file.name);
  });


  fetch('/admin/editProducts/<%= product._id %>', {
    method: 'POST',
    body: fd
  }).then(async res => {
    if (res.redirected) return window.location.href = res.url;
    if (!res.ok) {
      const txt = await res.text();
      alert('Update failed: ' + (txt || res.statusText));
      return;
    }

    window.location.href = '/admin/products';
  }).catch(err => {
    console.error(err);
    alert('Network error while updating');
  });
});


document.addEventListener('DOMContentLoaded', () => {

  renderThumbnails();
});
</script>

<%- include("../partials/admin/footer") %>
