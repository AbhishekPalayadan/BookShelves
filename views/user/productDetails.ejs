<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        .wishlist-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
}

    </style>
</head>
<body>
    
<%- include("../../views/partials/user/header", { user }) %>


<div class="breadcrumb" style="margin-left: 80px;">
    <a href="/">Home</a> /
    <a href="/products">All Books</a> /
    <span><%= product.product_name %></span>
</div>


<main class="product-details-page">

    <div class="product-container">


<div class="product-image-section">


<div class="main-image-wrapper zoom-container">
    <img id="mainImage" class="main-image"
         src="/uploads/product-images/<%= product.images[0] %>" 
         alt="<%= product.product_name %>">
</div>


    <div class="thumbnail-row">
        <% product.images.forEach(img => { %>
            <img 
                src="/uploads/product-images/<%= img %>" 
                class="thumbnail"
                onclick="changeImage(this.src)">
        <% }) %>
    </div>

</div>


        <div class="product-info">

<h1 class="pd-title"><%= product.product_name %></h1>
<p class="pd-author">by <span><%= product.author %></span></p>

            <div class="rating">
                ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (524)
            </div>

            <div class="price-box">
                <span class="new-price">‚Çπ<%= product.sale_price %></span>
                <% if (product.sale_price < product.regular_price) { %>
                    <span class="old-price">‚Çπ<%= product.regular_price %></span>
                <% } %>
            </div>

            <p class="product-description">
               Discover a thoughtfully crafted book designed to deliver an engaging reading experience. Printed with premium-quality pages and a comfortable layout, this book is perfect for readers who enjoy stories that inspire, entertain, and stay with you. Whether you're exploring new ideas or escaping into a gripping tale, this edition offers clarity, durability, and a smooth reading flow‚Äîmaking it an ideal addition to any bookshelf."
            </p>




<% if (product.stock > 10) { %>

    <p class="stock-status in">‚úî In Stock</p>

<% } else if (product.stock > 0) { %>

    <p class="stock-status low">‚è≥ Only <%= product.stock %> left in stock</p>

<% } else { %>

    <p class="stock-status out">‚ùå Out of Stock</p>

    <div class="unavailable-box">
        This product is currently unavailable.
    </div>

<% } %>

<% if (product.stock > 0) { %>
    <div class="quantity-section">
        <label>Quantity:</label>
    
    
        <div class="qty-box" data-stock="<%= product.stock %>">
            <button class="qty-btn" onclick="decreaseQty()">-</button>
            <input id="qtyInput" type="number" value="1" min="1" readonly>
            <button class="qty-btn" id="plusBtn" onclick="increaseQty()">+</button>
        </div>
    </div>

    <div class="button-group">
        <button onclick="addToCart('<%= product._id %>')" class="add-to-cart-btn">Add to Cart</button>

        <button class="wishlist-btn"
        onclick="toggleWishlist(this)"
        data-id="<%= product._id %>">

    <i class="fa-heart <%= isWishlisted ? 'fa-solid' : 'fa-regular' %>"
       style="<%= isWishlisted ? 'color:red' : '' %>">
    </i>

</button>
    </div>

    <!-- <button class="buy-now-btn">Buy Now</button> -->

<% } else { %>

    <div class="button-group">
        <button class="add-to-cart-btn btn-disabled">Add to Cart</button>

        <button class="wishlist-btn" id="wishlistBtn">
            <i id="wishlistIcon" class="fa-regular fa-heart"></i>
        </button>
    </div>

    <!-- <button class="buy-now-btn btn-disabled">Buy Now</button> -->

<% } %>




            <div class="delivery-info">

                <div class="delivery-box">
                    <div class="delivery-icon">üöö</div>
                    <div>
                        <h4>Free Delivery</h4>
                        <p>Delivery available on all orders</p>
                    </div>
                </div>

                <div class="delivery-box">
                    <div class="delivery-icon">üîÑ</div>
                    <div>
                        <h4>30 Days Return</h4>
                        <p>Free return policy</p>
                    </div>
                </div>

            </div>

        </div>
    </div>


<div class="tabs">
<div class="tab active" onclick="showTab('description', this)">Description</div>
<div class="tab" onclick="showTab('reviews', this)">Reviews</div>

</div>


<div id="description" class="tab-content active">
    
    <h2>Description</h2>
    <p><%= product.description %></p>

  
    <div class="book-details-box">
        <h3>Key Book Details</h3>

        <ul class="details-list">
            <li><span>Title:</span> <%= product.product_name %></li>
            <li><span>Author:</span> <%= product.author %></li>
            <li><span>Language:</span> <%= product.language %></li>

            <% if (product.published_date) { %>
            <li><span>Published Date:</span> 
                <%= new Date(product.published_date).toLocaleDateString("en-IN", {
                    day: "numeric", month: "long", year: "numeric"
                }) %>
            </li>
            <% } %>

            <li><span>Category:</span> 
                <%= product.category_id ? product.category_id.name : "N/A" %>
            </li>

            <% if (product.pages) { %>
            <li><span>Pages:</span> <%= product.pages %></li>
            <% } %>
        </ul>
    </div>

    <div class="static-features">
        <h3>Book Features</h3>
        <ul>
            <li>High-quality paperback / hardcover finish</li>
            <li>Crisp and clear printing</li>
            <li>Easy-to-read font and formatting</li>
            <li>Lightweight and comfortable to hold</li>
            <li>Perfect for gifting to readers of all ages</li>
            <li>Publisher-certified original copy</li>
        </ul>
    </div>

</div>


<div id="reviews" class="tab-content">
    <h2>Customer Reviews</h2>

  <!--  <div class="review-form-box">
    <h3>Write a Review</h3>


    <div class="star-rating">
        <input type="radio" name="rating" id="star5" value="5">
        <label for="star5">‚òÖ</label>

        <input type="radio" name="rating" id="star4" value="4">
        <label for="star4">‚òÖ</label>

        <input type="radio" name="rating" id="star3" value="3">
        <label for="star3">‚òÖ</label>

        <input type="radio" name="rating" id="star2" value="2">
        <label for="star2">‚òÖ</label>

        <input type="radio" name="rating" id="star1" value="1">
        <label for="star1">‚òÖ</label>
    </div>

    <textarea class="review-input" placeholder="Write your review..." rows="4"></textarea>


    <button class="submit-review-btn">Submit Review</button>
</div>
-->

    <div class="review">
        <h4>‚≠ê ‚≠ê ‚≠ê ‚≠ê ‚≠ê Excellent Read!</h4>
        <p>"Amazing book! The story kept me hooked from start to finish. Definitely worth buying."</p>
        <small>- Rahul M.</small>
    </div>

    <div class="review">
        <h4>‚≠ê ‚≠ê ‚≠ê ‚≠ê Great Quality</h4>
        <p>"Paper quality and printing are really good. Very comfortable to read. Fast delivery too!"</p>
        <small>- Ananya S.</small>
    </div>

    <div class="review">
        <h4>‚≠ê ‚≠ê ‚≠ê ‚≠ê ‚≠ê Highly Recommended</h4>
        <p>"One of the best books I‚Äôve read this year. Perfect for gifting as well."</p>
        <small>- Vivek K.</small>
    </div>

    <div class="review">
        <h4>‚≠ê ‚≠ê ‚≠ê ‚≠ê Good Experience</h4>
        <p>"Enjoyed it a lot. Smooth writing style and very engaging chapters."</p>
        <small>- Priya R.</small>
    </div>
</div>




    <div class="related-section">

        <div class="related-header">
            <h3>Related Books</h3>
            <a href="/products" class="see-all">See All</a>
        </div>

        <div class="related-grid">

            <% if (trending && trending.length > 0) { %>
                <% trending.forEach(product => { %>

<a href="/product-details/<%= product._id %>" class="product-card" style="text-decoration: none; color: inherit;">
    <div class="product-image">
        <img src="/uploads/product-images/<%= product.images[0] %>" alt="">
    </div>

    <div class="product-info">
        <p class="product-name"><%= product.product_name %></p>

        <p class="product-price">
            <span class="price-sale">‚Çπ<%= product.sale_price %></span>
            <% if (product.sale_price < product.regular_price) { %>
                <span class="price-original">‚Çπ<%= product.regular_price %></span>
            <% } %>
        </p>

        <div class="product-rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
    </div>
</a>
                <% }) %>
            <% } else { %>
                <p>No related books found.</p>
            <% } %>

        </div>

    </div>

</main>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    let activeToast=null;

function showToast(message, type = "error") {
  if (activeToast) {
    activeToast.hideToast();
  }

  activeToast = Toastify({
    text: message,
    duration: 2000,
    gravity: "top",          // top or bottom
    position: "center",      // REQUIRED for center
    offset: {
      x: 0,
      y: 20
    },
    close: true,
    stopOnFocus: true,
    style: {
      background: type === "success" ? "#2ecc71" : "#ff4757",
      textAlign: "center",
      borderRadius: "10px",
      fontWeight: "600"
    }
  });

  activeToast.showToast();
}



    const MAX_PER_PRODUCT = 10;
    function changeImage(src) {
        document.getElementById('mainImage').src = src;
    }

const mainImageWrapper = document.querySelector(".zoom-container");
const mainImageZoom = document.getElementById("mainImage");


mainImageWrapper.addEventListener("mousemove", (e) => {
    const rect = mainImageWrapper.getBoundingClientRect();

    let x = (e.clientX - rect.left) / rect.width;
    let y = (e.clientY - rect.top) / rect.height;

    mainImageZoom.style.transformOrigin = `${x * 100}% ${y * 100}%`;
    mainImageZoom.style.transform = "scale(2.5)";
});


mainImageWrapper.addEventListener("mouseleave", () => {
    mainImageZoom.style.transform = "scale(1)";
});


function showTab(tabName, clickedTab) {


    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });


    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });


    clickedTab.classList.add('active');


    document.getElementById(tabName).classList.add('active');
}


function increaseQty() {
    const qtyInput = document.getElementById("qtyInput");
    const plusBtn = document.getElementById("plusBtn");
    const qtyBox = document.querySelector(".qty-box");

    const stock = parseInt(qtyBox.dataset.stock);
    let qty = parseInt(qtyInput.value);

    // Stop if max limit reached
    if (qty >= MAX_PER_PRODUCT) {
        plusBtn.style.display = "none";

        showToast(`Maximum ${MAX_PER_PRODUCT} items allowed`)
        return;
    }

    // Stop if stock reached
    if (qty >= stock) {
        showToast(`Only ${stock} items available`)
        return;
    }

    qty++;
    qtyInput.value = qty;

    // Hide + button when qty hits max
    if (qty >= MAX_PER_PRODUCT) {
        plusBtn.style.display = "none";
    }
}



function decreaseQty() {
    const qtyInput = document.getElementById("qtyInput");
    const plusBtn = document.getElementById("plusBtn");

    let qty = parseInt(qtyInput.value);

    if (qty > 1) {
        qty--;
        qtyInput.value = qty;
    }

    // Show + button again when qty < max
    if (qty < MAX_PER_PRODUCT) {
        plusBtn.style.display = "inline-block";
    }
}


    const wishlistBtn = document.getElementById("wishlistBtn");
const wishlistIcon = document.getElementById("wishlistIcon");

async function addToCart(productId){
    const qtyInput=document.getElementById("qtyInput");
    const qtyBox=document.querySelector(".qty-box");

    const quantity=parseInt(qtyInput.value);
    const stock=parseInt(qtyBox.dataset.stock);

    if(quantity < 1){
        showToast("Quantity must be at least 1")
        return;
    }

    if(quantity>stock){
        showToast(`Only ${stock} items available`)
        return;
    }

    try{
        const res=await fetch("/cart/add",{
            method:"POST",
            headers:{
                "Content-Type":"application/json"
            },
            body:JSON.stringify({
                productId,
                quantity
            })
        })
        const data=await res.json();
        if (!res.ok) {
            showToast(data.message || "Failed to add to cart")
      return;
    }
    showToast(data.message,"success")

    }catch(err){
        showToast("Server error")
    }
}



async function toggleWishlist(btn) {
    const productId = btn.getAttribute("data-id");
    const icon = btn.querySelector("i");

    const res = await fetch("/wishlist/toggle", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ productId })
    });

    const data = await res.json();

    if (data.status === "added") {
        icon.classList.remove("fa-regular");
        icon.classList.add("fa-solid");
        icon.style.color = "red";
        showToast("Added to wishlist","success");
    } else if (data.status === "removed") {
        icon.classList.remove("fa-solid");
        icon.classList.add("fa-regular");
        icon.style.color = "black";
        showToast("Removed from wishlist")
    }
}


</script>

<%- include("../../views/partials/user/footer") %>

</body>
</html>
