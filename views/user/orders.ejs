<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders | Bookshelves</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ðŸ”’ STYLE UNCHANGED -->
  <style>
    /* ===== YOUR ORIGINAL STYLE â€“ NOT MODIFIED ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter','Segoe UI',sans-serif; background:#f5f6f8; color:#1f2937; }

    .main-container{max-width:1200px;margin:26px auto;padding:0 20px}
    .profile-layout{display:grid;grid-template-columns:280px 1fr;gap:30px;align-items:flex-start}
    .breadcrumb{display:flex;justify-content:space-between;margin-bottom:28px;font-size:14px;color:#6b7280}
    .breadcrumb a{color:#6b7280;text-decoration:none}
    .breadcrumb a:hover{color:#ff4757}
    .customer-name{color:#ff4757;font-weight:600}

    .content-card{background:#fff;border-radius:14px;padding:30px;box-shadow:0 8px 28px rgba(0,0,0,.08)}
    .page-title{font-size:22px;font-weight:600;margin-bottom:26px}

    .order-card{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;margin-bottom:26px;background:#fff}

    .order-header{
      background:#f9fafb;
      padding:10px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:20px;
      border-bottom:1px solid #e5e7eb;
      font-size:13px;
      justify-items:center
    }

    .header-label{color:#6b7280;font-size:12px;margin-bottom:4px}
    .header-value{font-weight:600;color:#111827}
    .header-link{color:#ff4757;text-decoration:none;font-size:13px}
    .header-link:hover{text-decoration:underline}

    .order-item{
      display:grid;
      grid-template-columns:3fr 6fr 2fr;
      gap:24px;
      padding:12px;
      align-items:center
    }

    .product-image-sec{
      width:110px;height:150px;border-radius:12px;overflow:hidden;
      border:1px solid #e5e7eb;background:#f3f4f6;position:relative
    }

    .product-image-sec img{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover
    }

    .product-info h3{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.4}
    .product-meta{font-size:13px;color:#6b7280;margin-bottom:4px}

    .order-actions{display:flex;flex-direction:column;gap:20px;align-items:center}
    .status{padding:5px 30px;border-radius:999px;font-size:11px;font-weight:700;letter-spacing:.4px}
    .pending{background:#fff3cd;color:#856404}
    .processing{background:#e0f2fe;color:#0369a1}
    .delivered{background:#dcfce7;color:#166534}
    .cancelled{background:#fee2e2;color:#991b1b}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:7px 14px;font-size:12px;font-weight:600;border-radius:8px;
      cursor:pointer;border:1px solid transparent;background:transparent;transition:.2s}

    .btn-cancel{color:#dc2626;border:1px solid #fecaca}
    .btn-cancel:hover{background:#fee2e2}

    .btn-return{color:#1d4ed8;border:1px solid #bfdbfe}
    .btn-return:hover{background:#dbeafe}

    .btn-invoice{padding: 3px; margin-top: 10px;margin-left: 10px;width: 200px; color:#374151;border:1px solid #d1d5db magi}
    .btn-invoice:hover{background:#f9fafb}

    @media(max-width:900px){
      .profile-layout{grid-template-columns:1fr}
      .order-header{grid-template-columns:1fr 1fr}
      .order-item{grid-template-columns:90px 1fr}
      .order-actions{grid-column:1/-1}
    }
  </style>
</head>

<body>

<%- include("../../views/partials/user/header") %>

<div class="main-container">

  <div class="breadcrumb">
    <div><a href="/">Home</a> / My Orders</div>
    <div>Welcome, <span class="customer-name"><%= user.fullname %></span></div>
  </div>

  <div class="profile-layout">

    <%- include("../partials/user/profileSidebar",{ user, activeMenu:"orders" }) %>

    <div class="content-card">
      <h1 class="page-title">My Orders</h1>

      <% if(!orders || orders.length === 0){ %>
        <p>No orders found.</p>
      <% } %>

      <% orders.forEach(order => { %>
        <div class="order-card" data-order-id="<%= order._id %>">

          <!-- ORDER HEADER -->
          <div class="order-header">
            <div>
              <div class="header-label">Order Placed</div>
              <div class="header-value"><%= new Date(order.createdAt).toDateString() %></div>
            </div>
            <div>
              <div class="header-label">Total</div>
              <div class="header-value">â‚¹ <%= order.totalAmount %></div>
            </div>
            <div>
              <div class="header-label">Ship To</div>
              <div class="header-value"><%= order.address.fullname %></div>
            </div>
            <div>
              <div class="header-label">Order</div>
              <a href="/orders/<%= order.orderId %>" class="header-link">View Details</a>
            </div>
          </div>

          <!-- <div>
            <button class="btn-invoice">Invoice</button>
        </div> -->
          <!-- ORDER ITEMS -->
          <% order.items.forEach(item => { %>
           
            <div class="order-item">

                
              <div class="product-image-sec">
                <img src="/uploads/product-images/<%= item.productId?.images?.[0] || 'no-image.png' %>">
              </div>

              <div class="product-info">
                <h3><%= item.productId?.product_name || 'Product' %></h3>
                <div class="product-meta">Qty: <%= item.quantity %></div>
                <div class="product-meta">â‚¹ <%= item.price %></div>
              </div>


              <div class="order-actions">
                <span class="status <%= item.status %>">
                  <%= item.status.replace("_"," ").toUpperCase() %>
                </span>
              
                <div class="actions">
              
                  <% if(item.status === "pending"){ %>
                    <button
                      class="btn btn-cancel"
                      onclick="cancelItem('<%= order._id %>','<%= item.productId._id %>', this)">
                      Cancel Item
                    </button>
                  <% } %>
              
                  <% if(item.status === "delivered"){ %>
                    <button
                      class="btn btn-return"
                      onclick="requestReturn('<%= order._id %>','<%= item.productId._id %>')">
                      Return
                    </button>
                  <% } %>
              
                </div>
              
                <% if(item.status === "return_requested"){ %>
                  <small style="font-size:12px;color:#6b7280">
                    Return requested
                  </small>
                <% } %>
              
                <% if(item.status === "return_rejected"){ %>
                  <small style="font-size:12px;color:#991b1b">
                    Return rejected
                  </small>
                <% } %>
              
              </div>
              



            </div>
          <% }) %>

        </div>
      <% }) %>

    </div>
  </div>
</div>

<%- include("../../views/partials/user/footer") %>

<script>
async function cancelItem(orderId, productId, btn){

if(!confirm("Cancel this item?")) return;

try {
  const res = await fetch('/orders/cancel-item', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ orderId, productId })
  });

  const data = await res.json();

  if(!data.success){
    alert(data.message || 'Cancel failed');
    return;
  }

  // update UI
  const itemCard = btn.closest('.order-item');
  const statusEl = itemCard.querySelector('.status');

  statusEl.innerText = 'CANCELLED';
  statusEl.className = 'status cancelled';

  btn.remove();

} catch (error) {
  console.log(error);
  alert('Something went wrong');
}
}


  async function requestReturn(orderId, productId){
    const reason = prompt("Please enter return reason (required)");
  
    if(!reason || reason.trim().length < 3){
      alert("Return reason is required");
      return;
    }
  
    try {
      const res = await fetch("/orders/return-item", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderId,
          productId,
          reason
        })
      });
  
      const data = await res.json();
  
      if(data.success){
        location.reload();
      } else {
        alert(data.message || "Return failed");
      }
  
    } catch (err) {
      console.error(err);
      alert("Something went wrong");
    }
  }
  </script>
  
</body>
</html>
